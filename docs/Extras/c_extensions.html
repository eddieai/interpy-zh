
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <title>使用 C 扩展 · HonKit</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 5.1.4">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/@honkit/honkit-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    
    <link rel="prev" href="targeting_python2_3.html" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">主页</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    主页
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">序</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../preface/Intro-2021.html">
            
                <a href="../preface/Intro-2021.html">
            
                    
                    2021更新版-序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../preface/Introduction.html">
            
                <a href="../preface/Introduction.html">
            
                    
                    2016首版-序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../preface/translator.html">
            
                <a href="../preface/translator.html">
            
                    
                    译者后记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="../preface/author.html">
            
                <a href="../preface/author.html">
            
                    
                    关于原作者
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="../preface/seealso.html">
            
                <a href="../preface/seealso.html">
            
                    
                    推荐阅读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="../preface/donors.html">
            
                <a href="../preface/donors.html">
            
                    
                    捐赠名单
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">程序员的工具</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../ProgrammerTools/virtual_environment.html">
            
                <a href="../ProgrammerTools/virtual_environment.html">
            
                    
                    虚拟环境（virtualenv）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../ProgrammerTools/debugging.html">
            
                <a href="../ProgrammerTools/debugging.html">
            
                    
                    调试（Debugging）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../ProgrammerTools/introspection.html">
            
                <a href="../ProgrammerTools/introspection.html">
            
                    
                    对象自省
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">语法</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../Syntax/exception.html">
            
                <a href="../Syntax/exception.html">
            
                    
                    异常
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="../Syntax/for_else.html">
            
                <a href="../Syntax/for_else.html">
            
                    
                    For - Else
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="../Syntax/ternary_operators.html">
            
                <a href="../Syntax/ternary_operators.html">
            
                    
                    三元运算符
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="../Syntax/global_return.html">
            
                <a href="../Syntax/global_return.html">
            
                    
                    Global 和 Return
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5" data-path="../Syntax/open_func.html">
            
                <a href="../Syntax/open_func.html">
            
                    
                    open 函数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.6" data-path="../Syntax/args_kwargs.html">
            
                <a href="../Syntax/args_kwargs.html">
            
                    
                    *args 和 **kwargs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.7" data-path="../Syntax/context_managers.html">
            
                <a href="../Syntax/context_managers.html">
            
                    
                    上下文管理器
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">函数式编程</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../FunctionalProgramming/enumerate.html">
            
                <a href="../FunctionalProgramming/enumerate.html">
            
                    
                    枚举
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="../FunctionalProgramming/lambdas.html">
            
                <a href="../FunctionalProgramming/lambdas.html">
            
                    
                    lambda 表达式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3" data-path="../FunctionalProgramming/set_data_structure.html">
            
                <a href="../FunctionalProgramming/set_data_structure.html">
            
                    
                    set（集合）数据结构
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.4" data-path="../FunctionalProgramming/map_n_filter.html">
            
                <a href="../FunctionalProgramming/map_n_filter.html">
            
                    
                    Map，Filter 和 Reduce
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.5" data-path="../FunctionalProgramming/Comprehensions.html">
            
                <a href="../FunctionalProgramming/Comprehensions.html">
            
                    
                    推导式(解析式)
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">数据结构</li>
        
        
    
        <li class="chapter " data-level="6.1" data-path="../DataStructures/generators.html">
            
                <a href="../DataStructures/generators.html">
            
                    
                    生成器（Generators）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2" data-path="../DataStructures/Coroutines.html">
            
                <a href="../DataStructures/Coroutines.html">
            
                    
                    协程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3" data-path="../DataStructures/classes.html">
            
                <a href="../DataStructures/classes.html">
            
                    
                    类
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">数据类型</li>
        
        
    
        <li class="chapter " data-level="7.1" data-path="../DataTypes/collections.html">
            
                <a href="../DataTypes/collections.html">
            
                    
                    容器（Collections）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.2" data-path="../DataTypes/mutation.html">
            
                <a href="../DataTypes/mutation.html">
            
                    
                    对象变动（Mutation）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.3" data-path="../DataTypes/slots_magic.html">
            
                <a href="../DataTypes/slots_magic.html">
            
                    
                    __slots__ 魔法
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">装饰器</li>
        
        
    
        <li class="chapter " data-level="8.1" data-path="../decorators/decorators.html">
            
                <a href="../decorators/decorators.html">
            
                    
                    装饰器原理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.2" data-path="../decorators/your_first_decorator.html">
            
                <a href="../decorators/your_first_decorator.html">
            
                    
                    你的第一个装饰器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.3" data-path="../decorators/deco_with_args.html">
            
                <a href="../decorators/deco_with_args.html">
            
                    
                    带参数的装饰器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.4" data-path="../decorators/func_caching.html">
            
                <a href="../decorators/func_caching.html">
            
                    
                    函数缓存（Function caching）
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">其他知识</li>
        
        
    
        <li class="chapter " data-level="9.1" data-path="onelines.html">
            
                <a href="onelines.html">
            
                    
                    一行式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="9.2" data-path="targeting_python2_3.html">
            
                <a href="targeting_python2_3.html">
            
                    
                    兼容 Python 2 和 3
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="9.3" data-path="c_extensions.html">
            
                <a href="c_extensions.html">
            
                    
                    使用 C 扩展
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            Published with HonKit
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >使用 C 扩展</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="使用-c-扩展">使用 C 扩展</h1>
<p>CPython 还为开发者实现了一个有趣的特性，使用 Python 可以轻松调用 C 代码。</p>
<p>开发者有三种方法可以在自己的 Python 代码中来调用 C 编写的函数──<code>ctypes</code>，<code>SWIG</code>，<code>Python/C API</code>。每种方式也都有各自的利弊。</p>
<p>首先，我们要明确为什么要在 Python 中调用 C？</p>
<p>常见原因如下：</p>
<ul>
<li>你要提升代码的运行速度，而且你知道 C 要比 Python 快50倍以上；</li>
<li>C 语言中有很多传统类库，而且有些正是你想要的，但你又不想用 Python 去重写它们；</li>
<li>想对从内存到文件接口这样的底层资源进行访问；</li>
<li>不需要理由，就是想这样做。</li>
</ul>
<h1 id="ctypes">CTypes</h1>
<p>Python 中的 <a href="https://docs.python.org/2/library/ctypes.html" target="_blank">ctypes 模块</a>可能是 Python 调用 C 方法中最简单的一种。ctypes 模块提供了和 C 语言兼容的数据类型和函数来加载 dll 文件，因此在调用时不需对源文件做任何的修改。也正是如此奠定了这种方法的简单性。</p>
<p>示例如下</p>
<p>实现两数求和的C代码，保存为 <code>add.c</code>：</p>
<pre><code class="lang-C"><span class="hljs-comment">//sample C file to add 2 numbers - int and floats</span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-type">int</span> <span class="hljs-title function_">add_int</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">int</span>)</span>;
<span class="hljs-type">float</span> <span class="hljs-title function_">add_float</span><span class="hljs-params">(<span class="hljs-type">float</span>, <span class="hljs-type">float</span>)</span>;

<span class="hljs-type">int</span> <span class="hljs-title function_">add_int</span><span class="hljs-params">(<span class="hljs-type">int</span> num1, <span class="hljs-type">int</span> num2)</span>{
    <span class="hljs-keyword">return</span> num1 + num2;

}

<span class="hljs-type">float</span> <span class="hljs-title function_">add_float</span><span class="hljs-params">(<span class="hljs-type">float</span> num1, <span class="hljs-type">float</span> num2)</span>{
    <span class="hljs-keyword">return</span> num1 + num2;

}
</code></pre>
<p>接下来将C文件编译为 <code>.so</code> 文件（windows 下为 DLL）。下面操作会生成 <code>adder.so</code> 文件：</p>
<pre><code class="lang-Shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">For Linux</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash"> gcc -shared -Wl,-soname,adder -o adder.so -fPIC add.c</span>
<span class="hljs-meta prompt_">
#</span><span class="language-bash">For Mac</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">gcc -shared -Wl,-install_name,adder.so -o adder.so -fPIC add.c</span>
</code></pre>
<p>现在在你的Python代码中来调用它</p>
<pre><code class="lang-Python"><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *

<span class="hljs-comment">#load the shared object file</span>
adder = CDLL(<span class="hljs-string">'./adder.so'</span>)

<span class="hljs-comment">#Find sum of integers</span>
res_int = adder.add_int(<span class="hljs-number">4</span>,<span class="hljs-number">5</span>)
<span class="hljs-built_in">print</span> <span class="hljs-string">"Sum of 4 and 5 = "</span> + <span class="hljs-built_in">str</span>(res_int)

<span class="hljs-comment">#Find sum of floats</span>
a = c_float(<span class="hljs-number">5.5</span>)
b = c_float(<span class="hljs-number">4.1</span>)

add_float = adder.add_float
add_float.restype = c_float
<span class="hljs-built_in">print</span> <span class="hljs-string">"Sum of 5.5 and 4.1 = "</span>, <span class="hljs-built_in">str</span>(add_float(a, b))
</code></pre>
<p>输出如下</p>
<pre><code class="lang-Shell">Sum of 4 and 5 = 9
Sum of 5.5 and 4.1 =  9.60000038147
</code></pre>
<p>在这个例子中，C 文件是自解释的，它包含两个函数，分别实现了整形求和和浮点型求和。</p>
<p>在Python文件中，一开始先导入 ctypes 模块，然后使用 CDLL 函数来加载我们创建的库文件。这样我们就可以通过变量 <code>adder</code> 来使用 C 类库中的函数了。当 <code>adder.add_int()</code> 被调用时，内部将发起一个对 C 函数 <code>add_int</code> 的调用。ctypes 接口允许我们在调用 C 函数时使用原生 Python 中默认的字符串型和整型。</p>
<p>而对于其他类似布尔型和浮点型这样的类型，必须要使用正确的 ctype 类型才可以。如向 <code>adder.add_float()</code> 函数传参时, 我们要先将Python中的十进制值转化为 c_float 类型，然后才能传送给 C 函数。这种方法虽然简单，清晰，但是却很受限。例如，并不能在 C 中对对象进行操作。</p>
<h1 id="swig">SWIG</h1>
<p>SWIG 是 Simplified Wrapper and Interface Generator 的缩写，是 Python 中调用C代码的另一种方法。在这个方法中，开发人员必须编写一个额外的接口文件来作为 SWIG（终端工具）的入口。</p>
<p>Python开发者一般不会采用这种方法，因为大多数情况它会带来不必要的复杂。而当你有一个 C/C++ 代码库需要被多种语言调用时，这将是个非常不错的选择。</p>
<p>示例如下(来自<a href="http://www.swig.org/tutorial.html" target="_blank">SWIG官网</a>)</p>
<p><code>example.c</code> 文件中的C代码包含了不同的变量和函数：</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span>
<span class="hljs-type">double</span> My_variable = <span class="hljs-number">3.0</span>;

<span class="hljs-type">int</span> <span class="hljs-title function_">fact</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> {
    <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> n*fact(n<span class="hljs-number">-1</span>);

}

<span class="hljs-type">int</span> <span class="hljs-title function_">my_mod</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span> {
    <span class="hljs-keyword">return</span> (x%y);

}

<span class="hljs-type">char</span> *<span class="hljs-title function_">get_time</span><span class="hljs-params">()</span>
{
    <span class="hljs-type">time_t</span> ltime;
    time(&amp;ltime);
    <span class="hljs-keyword">return</span> ctime(&amp;ltime);

}
</code></pre>
<p>编译它：</p>
<pre><code class="lang-Shell">unix % swig -python example.i
unix % gcc -c example.c example_wrap.c \
    -I/usr/local/include/python2.1
unix % ld -shared example.o example_wrap.o -o _example.so
</code></pre>
<p>最后，Python的输出：</p>
<pre><code class="lang-Python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> example
<span class="hljs-meta">&gt;&gt;&gt; </span>example.fact(<span class="hljs-number">5</span>)
<span class="hljs-number">120</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>example.my_mod(<span class="hljs-number">7</span>,<span class="hljs-number">3</span>)
<span class="hljs-number">1</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>example.get_time()
<span class="hljs-string">'Sun Feb 11 23:01:07 1996'</span>
&gt;&gt;&gt;
</code></pre>
<p>我们可以看到，使用SWIG确实达到了同样的效果，虽然下了更多的工夫，但如果你的目标是多语言还是很值得的。</p>
<h1 id="pythonc-api">Python/C API</h1>
<p><a href="https://docs.python.org/2/c-api/" target="_blank">Python/C API</a> 可能是被最广泛使用的方法。它不仅简单，而且可以在 C 代码中操作你的 Python 对象。</p>
<p>这种方法需要以特定的方式来编写 C 代码以供 Python 去调用它。所有的 Python 对象都被表示为一种叫做 PyObject 的结构体，并且 <code>Python.h</code> 头文件中提供了各种操作它的函数。例如，如果 PyObject 表示为 PyListType（列表类型）时，那么我们便可以使用 <code>PyList_Size()</code> 函数来获取该结构的长度，类似 Python 中的 <code>len(list)</code> 函数。大部分对Python原生对象的基础函数和操作在 <code>Python.h</code> 头文件中都能找到。</p>
<h2 id="示例">示例</h2>
<p>编写一个 C 扩展，添加所有元素到一个 Python 列表(所有元素都是数字)。</p>
<p>来看一下我们要实现的效果，这里演示了用Python调用C扩展的代码</p>
<pre><code class="lang-Python"><span class="hljs-comment">#Though it looks like an ordinary python import, the addList module is implemented in C</span>
<span class="hljs-keyword">import</span> addList

l = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>]
<span class="hljs-built_in">print</span> <span class="hljs-string">"Sum of List - "</span> + <span class="hljs-built_in">str</span>(l) + <span class="hljs-string">" = "</span> +  <span class="hljs-built_in">str</span>(addList.add(l))
</code></pre>
<p>上面的代码和普通的 Python 文件并没有什么分别，导入并使用了另一个叫做 <code>addList</code> 的Python模块。唯一差别就是这个模块并不是用 Python 编写的，而是 C。</p>
<p>接下来我们看看如何用C编写 <code>addList</code> 模块，这可能看起来有点让人难以接受，但是一旦你了解了这之中的各种组成，你就可以一往无前了。</p>
<pre><code class="lang-C"><span class="hljs-comment">//Python.h has all the required function definitions to manipulate the Python objects</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Python.h&gt;</span></span>

<span class="hljs-comment">//This is the function that is called from your python code</span>
<span class="hljs-type">static</span> PyObject* <span class="hljs-title function_">addList_add</span><span class="hljs-params">(PyObject* self, PyObject* args)</span>{

    PyObject * listObj;

    <span class="hljs-comment">//The input arguments come as a tuple, we parse the args to get the various variables</span>
    <span class="hljs-comment">//In this case it's only one list variable, which will now be referenced by listObj</span>
    <span class="hljs-keyword">if</span> (! PyArg_ParseTuple( args, <span class="hljs-string">"O"</span>, &amp;listObj ))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;

    <span class="hljs-comment">//length of the list</span>
    <span class="hljs-type">long</span> length = PyList_Size(listObj);

    <span class="hljs-comment">//iterate over all the elements</span>
    <span class="hljs-type">int</span> i, sum =<span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; length; i++) {
        <span class="hljs-comment">//get an element out of the list - the element is also a python objects</span>
        PyObject* temp = PyList_GetItem(listObj, i);
        <span class="hljs-comment">//we know that object represents an integer - so convert it into C long</span>
        <span class="hljs-type">long</span> elem = PyInt_AsLong(temp);
        sum += elem;
    }

    <span class="hljs-comment">//value returned back to python code - another python object</span>
    <span class="hljs-comment">//build value here converts the C long to a python integer</span>
    <span class="hljs-keyword">return</span> Py_BuildValue(<span class="hljs-string">"i"</span>, sum);

}

<span class="hljs-comment">//This is the docstring that corresponds to our 'add' function.</span>
<span class="hljs-type">static</span> <span class="hljs-type">char</span> addList_docs[] =
<span class="hljs-string">"add(  ): add all elements of the list\n"</span>;

<span class="hljs-comment">/* This table contains the relavent info mapping -
   &lt;function-name in python module&gt;, &lt;actual-function&gt;,
   &lt;type-of-args the function expects&gt;, &lt;docstring associated with the function&gt;
 */</span>
<span class="hljs-type">static</span> PyMethodDef addList_funcs[] = {
    {<span class="hljs-string">"add"</span>, (PyCFunction)addList_add, METH_VARARGS, addList_docs},
    {<span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>}

};

<span class="hljs-comment">/*
   addList is the module name, and this is the initialization block of the module.
   &lt;desired module name&gt;, &lt;the-info-table&gt;, &lt;module's-docstring&gt;
 */</span>
PyMODINIT_FUNC <span class="hljs-title function_">initaddList</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>{
    Py_InitModule3(<span class="hljs-string">"addList"</span>, addList_funcs,
            <span class="hljs-string">"Add all ze lists"</span>);

}
</code></pre>
<p>逐步解释</p>
<ul>
<li><code>Python.h</code> 头文件中包含了所有需要的类型（Python对象类型的表示）和函数定义（对Python对象的操作）；</li>
<li>接下来我们编写将要在 Python 调用的函数, 函数传统的命名方式由{模块名}_{函数名}组成，所以我们将其命名为 <code>addList_add</code>；</li>
<li>然后填写想在模块内实现函数的相关信息表，每行一个函数，以空行作为结束</li>
<li>最后的模块初始化块签名为 <code>PyMODINIT_FUNC init{模块名}</code>。</li>
</ul>
<p>函数 <code>addList_add</code> 接受的参数类型为 PyObject 类型结构(同时也表示为元组类型，因为 Python 中万物皆为对象，所以我们先用 PyObject 来定义)。传入的参数则通过 <code>PyArg_ParseTuple()</code> 来解析。第一个参数是被解析的参数变量。第二个参数是一个字符串，告诉我们如何去解析元组中每一个元素。字符串的第 n 个字母正是代表着元组中第 n 个参数的类型。例如，"i" 代表整形，"s" 代表字符串类型, "O" 则代表一个 Python 对象。接下来的参数都是你想要通过 <code>PyArg_ParseTuple()</code> 函数解析并保存的元素。这样参数的数量和模块中函数期待得到的参数数量就可以保持一致，并保证了位置的完整性。例如，我们想传入一个字符串，一个整数和一个 Python 列表，可以这样去写：</p>
<pre><code class="lang-C"><span class="hljs-type">int</span> n;
<span class="hljs-type">char</span> *s;
PyObject* <span class="hljs-built_in">list</span>;
PyArg_ParseTuple(args, <span class="hljs-string">"siO"</span>, &amp;n, &amp;s, &amp;<span class="hljs-built_in">list</span>);
</code></pre>
<p>在这种情况下，我们只需要提取一个列表对象，并将它存储在 <code>listObj</code> 变量中。然后用列表对象中的 <code>PyList_Size()</code> 函数来获取它的长度。就像 Python 中调用<code>len(list)</code>。</p>
<p>现在我们通过循环列表，使用 <code>PyList_GetItem(list, index)</code> 函数来获取每个元素。这将返回一个 <code>PyObject*</code> 对象。既然 Python 对象也能表示 <code>PyIntType</code>，我们只要使用 <code>PyInt_AsLong(PyObj *)</code> 函数便可获得我们所需要的值。我们对每个元素都这样处理，最后再得到它们的总和。</p>
<p>总和将被转化为一个Python对象并通过 <code>Py_BuildValue()</code> 返回给 Python 代码，这里的 i 表示我们要返回一个 Python 整形对象。</p>
<p>现在我们已经编写完 C 模块了。将下列代码保存为 <code>setup.py</code>：</p>
<pre><code class="lang-Python"><span class="hljs-comment">#build the modules</span>

<span class="hljs-keyword">from</span> distutils.core <span class="hljs-keyword">import</span> setup, Extension

setup(name=<span class="hljs-string">'addList'</span>, version=<span class="hljs-string">'1.0'</span>,  \
      ext_modules=[Extension(<span class="hljs-string">'addList'</span>, [<span class="hljs-string">'adder.c'</span>])])
</code></pre>
<p>并且运行：</p>
<pre><code class="lang-Shell">python setup.py install
</code></pre>
<p>现在应该已经将我们的 C 文件编译安装到我们的 Python 模块中了。</p>
<p>在一番辛苦后，让我们来验证下我们的模块是否有效：</p>
<pre><code class="lang-Python"><span class="hljs-comment">#module that talks to the C code</span>
<span class="hljs-keyword">import</span> addList

l = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>]
<span class="hljs-built_in">print</span> <span class="hljs-string">"Sum of List - "</span> + <span class="hljs-built_in">str</span>(l) + <span class="hljs-string">" = "</span> +  <span class="hljs-built_in">str</span>(addList.add(l))
</code></pre>
<p>输出结果如下：</p>
<pre><code class="lang-Shell">Sum of List - [1, 2, 3, 4, 5] = 15
</code></pre>
<p>如你所见，我们已经使用 Python.h API 成功开发出了我们第一个 Python C 扩展。这种方法看似复杂，但你一旦习惯，它将变的非常有效。</p>
<p>Python 调用 C 代码的另一种方式便是使用 <a href="http://cython.org/" target="_blank">Cython</a> 让 Python 编译的更快。但是 Cython 和传统的 Python 比起来可以将它理解为另一种语言，所以我们就不在这里过多描述了。</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="targeting_python2_3.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: 兼容 Python 2 和 3">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"parent":"其他知识","nav_order":3,"title":"使用 C 扩展","level":"9.3","depth":1,"previous":{"title":"兼容 Python 2 和 3","level":"9.2","depth":1,"path":"Extras/targeting_python2_3.md","ref":"Extras/targeting_python2_3.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"Extras/c_extensions.md","mtime":"2024-08-30T16:23:28.107Z","type":"markdown"},"gitbook":{"version":"5.1.4","time":"2024-08-30T16:31:31.311Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

